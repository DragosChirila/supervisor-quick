<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>supervisor-quick by lxyu</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>supervisor-quick</h1>
        <p>Bypass supervisor&#39;s nasty callbacks stack and make it quick!</p>
        <p class="view"><a href="https://github.com/lxyu/supervisor-quick">View the Project on GitHub <small>lxyu/supervisor-quick</small></a></p>
        <ul>
          <li><a href="https://github.com/lxyu/supervisor-quick/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/lxyu/supervisor-quick/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/lxyu/supervisor-quick">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="supervisor-quick" class="anchor" href="#supervisor-quick"><span class="octicon octicon-link"></span></a>supervisor-quick</h1>

<p>Bypass supervisor's nasty callbacks stack and make it quick!</p>

<h2>
<a name="usage" class="anchor" href="#usage"><span class="octicon octicon-link"></span></a>Usage</h2>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>pip install supervisor-quick
</pre></div>

<p>And add the following config to <code>supervisord.conf</code>.</p>

<div class="highlight highlight-ini"><pre><span class="k">[ctlplugin:quick]</span>
<span class="na">supervisor.ctl_factory</span> <span class="o">=</span> <span class="s">supervisor_quick:make_quick_controllerplugin</span>
</pre></div>

<p>Then start <code>supervisorctl</code> and use <code>quickstart</code> and <code>quickstop</code> to
start/stop processes.</p>

<pre><code>&gt; quickstart app:0
&gt; quickstart app:
&gt; quickstart ap*
&gt; quickstart all

&gt; quickstop app:1
&gt; quickstop app:
&gt; quickstop ap*
&gt; quickstop all
</code></pre>

<p>It effects <code>supervisorctl</code>, so you don't have to restart the whole
supervisord to make it work.</p>

<h2>
<a name="why" class="anchor" href="#why"><span class="octicon octicon-link"></span></a>Why</h2>

<p>I write this plugin because supervisor is just tooooo slow in
stop/start app server in our prod servers.</p>

<p>And I checked the source code and found it is because of the
nasty callbacks stack, and this is a quote from source code
<code>supervisor/rpcinterface.py</code>.</p>

<blockquote>
<p>XXX the above implementation has a weakness inasmuch as the
first call into each individual process callback will always
return NOT_DONE_YET, so they need to be called twice. The
symptom of this is that calling this method causes the
client to block for much longer than it actually requires to
kill all of the running processes. After the first call to
the killit callback, the process is actually dead, but the
above killall method processes the callbacks one at a time
during the select loop, which, because there is no output
from child processes after e.g. stopAllProcesses is called,
is not busy, so hits the timeout for each callback. I
attempted to make this better, but the only way to make it
better assumes totally synchronous reaping of child
processes, which requires infrastructure changes to
supervisord that are scary at the moment as it could take a
while to pin down all of the platform differences and might
require a C extension to the Python signal module to allow
the setting of ignore flags to signals.</p>
</blockquote>

<p>And this plugin will do a <code>quick</code> start/stop action that bypass
all the callback checks, making it lightning fast.</p>

<p>It also have wildcard concurrent execution support, keeping it fast
regardless of processes amount. (This function is inspired by
<a href="https://github.com/aleszoulek/supervisor-wildcards">supervisor-wildcards</a>)</p>

<h2>
<a name="example" class="anchor" href="#example"><span class="octicon octicon-link"></span></a>Example</h2>

<p>An example time demo for a app server with numprocs set to 32 to show how quick
supervisor can be with <code>quick</code> command.</p>

<div class="highlight highlight-bash"><pre><span class="nv">$ </span>supervisorctl status
app:0                            STOPPED
app:1                            STOPPED
app:10                           STOPPED
......
app:7                            STOPPED
app:8                            STOPPED
app:9                            STOPPED

<span class="nv">$ </span><span class="nb">time </span>supervisorctl start app:
24: started
25: started
26: started
......
18: started
31: started
30: started
supervisorctl start app:  0.06s user 0.02s system 0% cpu 48.442 total

<span class="nv">$ </span><span class="nb">time </span>supervisorctl stop app:
24: stopped
25: stopped
26: stopped
......
18: stopped
31: stopped
30: stopped
supervisorctl stop app:  0.06s user 0.03s system 0% cpu 36.278 total

<span class="nv">$ </span><span class="nb">time </span>supervisorctl quickstart app:
app:25: started
app:24: started
app:27: started
......
app:1: started
app:8: started
app:9: started
supervisorctl quickstart app:  0.09s user 0.03s system 19% cpu 0.618 total

<span class="nv">$ </span><span class="nb">time </span>supervisorctl quickstop app:
app:26: stoped
app:27: stoped
app:22: stoped
......
app:0: stoped
app:9: stoped
app:8: stoped
supervisorctl quickstop app:  0.09s user 0.04s system 68% cpu 0.196 total
</pre></div>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/lxyu">lxyu</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>